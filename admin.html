<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdnjs.cloudflare.com; font-src 'self' https://fonts.gstatic.com https://cdnjs.cloudflare.com; img-src 'self' data:; connect-src 'self' http://localhost:* http://127.0.0.1:*;">
    <title>Panel de Administración - Parrillada Alcume</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;500;600;700&family=Playfair+Display:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --color-primary: #8B0000;
            --color-primary-dark: #5C0000;
            --color-secondary: #D4A574;
            --color-dark: #1A1A1A;
            --color-light: #F5F5F0;
            --color-white: #FFFFFF;
            --color-text: #333333;
            --color-text-light: #666666;
            --font-primary: 'Playfair Display', Georgia, serif;
            --font-secondary: 'Open Sans', Arial, sans-serif;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: var(--font-secondary);
            background-color: #f5f5f5;
            color: var(--color-text);
        }

        .admin-header {
            background-color: var(--color-dark);
            color: var(--color-white);
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .admin-header h1 {
            font-family: var(--font-primary);
            font-size: 24px;
        }

        .admin-header h1 span { color: var(--color-secondary); }

        .admin-nav { display: flex; gap: 20px; }
        .admin-nav a {
            color: var(--color-white);
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 4px;
            transition: background-color 0.3s;
        }
        .admin-nav a:hover, .admin-nav a.active { background-color: var(--color-primary); }

        .admin-container {
            max-width: 1400px;
            margin: 30px auto;
            padding: 0 30px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--color-white);
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .stat-card i {
            font-size: 36px;
            color: var(--color-primary);
            margin-bottom: 15px;
        }

        .stat-card h3 {
            font-size: 32px;
            color: var(--color-dark);
            margin-bottom: 5px;
        }

        .stat-card p { color: var(--color-text-light); }

        .admin-section {
            background: var(--color-white);
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .admin-section h2 {
            font-family: var(--font-primary);
            font-size: 28px;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--color-primary);
        }

        .filter-bar {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-bar input, .filter-bar select {
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: var(--font-secondary);
        }

        .filter-bar button {
            padding: 10px 20px;
            background-color: var(--color-primary);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .filter-bar button:hover { background-color: var(--color-primary-dark); }

        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #eee; }
        th { background-color: var(--color-light); font-weight: 600; color: var(--color-dark); }
        tr:hover { background-color: #f9f9f9; }

        .status-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }
        .status-confirmada { background-color: #d4edda; color: #155724; }
        .status-cancelada { background-color: #f8d7da; color: #721c24; }
        .status-completada { background-color: #d1ecf1; color: #0c5460; }

        .action-buttons { display: flex; gap: 8px; }
        .action-buttons button {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            transition: opacity 0.3s;
        }
        .action-buttons button:hover { opacity: 0.8; }
        .btn-view { background-color: #17a2b8; color: white; }
        .btn-cancel { background-color: #dc3545; color: white; }

        /* Modal Login */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none; /* Oculto por defecto */
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 8px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .login-form input {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .login-form button {
            width: 100%;
            padding: 10px;
            background-color: var(--color-primary);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .hidden { display: none !important; }
        
        @media (max-width: 768px) {
            .admin-header { flex-direction: column; gap: 15px; }
            .admin-nav { flex-wrap: wrap; justify-content: center; }
            table { font-size: 14px; }
            th, td { padding: 8px 10px; }
        }
    </style>
</head>
<body>
    <header class="admin-header">
        <h1>Parrillada <span>Alcume</span> - Admin</h1>
        <nav class="admin-nav">
            <a href="#" class="active" onclick="return false;"><i class="fas fa-calendar-alt"></i> Reservas</a>
            <a href="#" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Salir</a>
            <a href="index.html" target="_blank"><i class="fas fa-external-link-alt"></i> Ver Web</a>
        </nav>
    </header>

    <!-- Modal Login -->
    <div id="loginModal" class="modal-overlay" style="display: flex;">
        <div class="modal-content">
            <h2 style="margin-bottom: 20px; text-align: center;">Acceso Restringido</h2>
            <form class="login-form" onsubmit="handleLogin(event)">
                <input type="text" id="username" placeholder="Usuario" required>
                <input type="password" id="password" placeholder="Contraseña" required>
                <button type="submit">Entrar</button>
                <p id="loginError" style="color: red; margin-top: 10px; display: none; text-align: center;"></p>
            </form>
        </div>
    </div>

    <!-- Modal Detalles -->
    <div id="detailsModal" class="modal-overlay">
        <div class="modal-content" style="max-width: 600px;">
            <h2 style="margin-bottom: 20px;">Detalles de Reserva</h2>
            <div id="detailsContent" style="margin-bottom: 20px;"></div>
            <button onclick="document.getElementById('detailsModal').style.display='none'" style="padding: 10px 20px; background: #666; color: white; border: none; border-radius: 4px; cursor: pointer;">Cerrar</button>
        </div>
    </div>

    <div id="mainContent" class="admin-container hidden">
        <div class="stats-grid">
            <div class="stat-card">
                <i class="fas fa-calendar-check"></i>
                <h3 id="totalReservas">-</h3>
                <p>Reservas Hoy</p>
            </div>
            <div class="stat-card">
                <i class="fas fa-users"></i>
                <h3 id="totalPersonas">-</h3>
                <p>Comensales Hoy</p>
            </div>
            <div class="stat-card">
                <i class="fas fa-chart-line"></i>
                <h3 id="ocupacion">-</h3>
                <p>Ocupación Actual</p>
            </div>
            <div class="stat-card">
                <i class="fas fa-calendar-week"></i>
                <h3 id="reservasSemana">-</h3>
                <p>Reservas esta Semana</p>
            </div>
        </div>

        <div class="admin-section">
            <h2><i class="fas fa-calendar-alt"></i> Gestión de Reservas</h2>
            
            <div class="filter-bar">
                <input type="date" id="filtroFecha" value="">
                <select id="filtroEstado">
                    <option value="">Todos los estados</option>
                    <option value="confirmada">Confirmada</option>
                    <option value="cancelada">Cancelada</option>
                </select>
                <input type="text" id="filtroBusqueda" placeholder="Buscar por nombre, email o código...">
                <button onclick="cargarReservas()"><i class="fas fa-search"></i> Buscar</button>
            </div>

            <div id="tablaReservas">
                <div class="loading">
                    <i class="fas fa-spinner"></i>
                    <p>Cargando reservas...</p>
                </div>
            </div>

            <!-- Paginación -->
            <div id="pagination" style="display: flex; justify-content: center; align-items: center; gap: 20px; margin-top: 20px;">
                <button id="prevPage" onclick="cambiarPagina(-1)" disabled>Anterior</button>
                <span id="pageInfo">Página 1 de 1</span>
                <button id="nextPage" onclick="cambiarPagina(1)" disabled>Siguiente</button>
            </div>
        </div>
    </div>

    <!-- Modal Editar -->
    <div id="editModal" class="modal-overlay">
        <div class="modal-content">
            <h2 style="margin-bottom: 20px;">Editar Reserva</h2>
            <form id="editForm" onsubmit="guardarEdicion(event)">
                <input type="hidden" id="editCodigo">
                
                <label>Nombre:</label>
                <input type="text" id="editNombre" required>
                
                <label>Apellidos:</label>
                <input type="text" id="editApellidos" required>
                
                <label>Email:</label>
                <input type="email" id="editEmail" required>
                
                <label>Fecha:</label>
                <input type="date" id="editFecha" required>
                
                <label>Hora:</label>
                <input type="time" id="editHora" required>
                
                <label>Personas:</label>
                <input type="number" id="editPersonas" min="1" max="20" required>
                
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="button" onclick="document.getElementById('editModal').style.display='none'" style="background: #666;">Cancelar</button>
                    <button type="submit">Guardar Cambios</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const API_URL = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
            ? 'http://localhost:3001/api'
            : '/api';

        let authHeader = sessionStorage.getItem('adminAuth') || null;
        let currentPage = 1;
        let totalPages = 1;

        // Inicialización
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('filtroFecha').valueAsDate = new Date();
            
            if (authHeader) {
                document.getElementById('loginModal').style.display = 'none';
                document.getElementById('mainContent').classList.remove('hidden');
                cargarReservas();
            }
        });

        // Gestión de Sesión
        function handleLogin(e) {
            e.preventDefault();
            const user = document.getElementById('username').value;
            const pass = document.getElementById('password').value;
            const errorMsg = document.getElementById('loginError');

            if (!user || !pass) {
                errorMsg.textContent = 'Por favor, introduce usuario y contraseña';
                errorMsg.style.display = 'block';
                return;
            }

            // Crear header de autenticación básica
            const credentials = btoa(`${user}:${pass}`);
            const tempAuth = `Basic ${credentials}`;

            // Verificar credenciales intentando cargar datos
            fetch(`${API_URL}/reservas/admin/lista?limit=1`, {
                headers: { 'Authorization': tempAuth }
            })
            .then(response => {
                if (response.status === 401) {
                    throw new Error('Credenciales inválidas');
                }
                if (!response.ok) {
                    throw new Error('Error de conexión');
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    authHeader = tempAuth;
                    sessionStorage.setItem('adminAuth', authHeader);
                    document.getElementById('loginModal').style.display = 'none';
                    document.getElementById('mainContent').classList.remove('hidden');
                    cargarReservas();
                    // Limpiar formulario
                    document.getElementById('username').value = '';
                    document.getElementById('password').value = '';
                    errorMsg.style.display = 'none';
                } else {
                     throw new Error('Error inesperado');
                }
            })
            .catch(error => {
                console.error(error);
                errorMsg.textContent = error.message === 'Credenciales inválidas' ? 'Usuario o contraseña incorrectos' : 'Error de conexión';
                errorMsg.style.display = 'block';
            });
        }

        function logout() {
            sessionStorage.removeItem('adminAuth');
            authHeader = null;
            document.getElementById('mainContent').classList.add('hidden');
            document.getElementById('loginModal').style.display = 'flex';
        }
        
        function formatearFecha(fechaString) {
            if (!fechaString) return '-';
            const fecha = new Date(fechaString);
            return fecha.toLocaleDateString('es-ES', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
        }

        // Cargar datos
        async function cargarReservas(page = 1) {
            const fecha = document.getElementById('filtroFecha').value;
            const estado = document.getElementById('filtroEstado').value;
            const busqueda = document.getElementById('filtroBusqueda').value;

            try {
                let url = `${API_URL}/reservas/admin/lista?page=${page}&limit=10&`;
                if (fecha) url += `fecha=${fecha}&`;
                if (estado) url += `estado=${estado}&`;
                if (busqueda) url += `busqueda=${encodeURIComponent(busqueda)}&`;

                const response = await fetch(url, {
                    headers: { 'Authorization': authHeader }
                });

                if (response.status === 401) {
                    logout();
                    return;
                }

                const result = await response.json();

                if (result.success) {
                    mostrarReservas(result.data);
                    
                    // Actualizar paginación
                    currentPage = result.pagination.page;
                    totalPages = result.pagination.totalPages;
                    document.getElementById('pageInfo').textContent = `Página ${currentPage} de ${totalPages}`;
                    document.getElementById('prevPage').disabled = currentPage <= 1;
                    document.getElementById('nextPage').disabled = currentPage >= totalPages;

                    // Si estamos en la página 1, actualizar estadísticas generales
                    if (currentPage === 1) actualizarEstadisticas(result.data); 
                }
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('tablaReservas').innerHTML = '<p class="alert alert-warning">Error de conexión</p>';
            }
        }

        function cambiarPagina(delta) {
            const newPage = currentPage + delta;
            if (newPage >= 1 && newPage <= totalPages) {
                cargarReservas(newPage);
            }
        }

        // Función para escapar HTML y prevenir XSS
        function escapeHtml(text) {
            if (text === null || text === undefined) return '';
            return String(text)
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        function mostrarReservas(reservas) {
            const container = document.getElementById('tablaReservas');
            
            if (reservas.length === 0) {
                container.innerHTML = '<p style="text-align: center; padding: 40px; color: #666;">No se encontraron reservas</p>';
                return;
            }

            const html = `
                <table>
                    <thead>
                        <tr>
                            <th>Código</th>
                            <th>Nombre</th>
                            <th>Fecha</th>
                            <th>Hora</th>
                            <th>Personas</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${reservas.map(r => `
                            <tr>
                                <td><strong>${escapeHtml(r.codigo)}</strong></td>
                                <td>${escapeHtml(r.nombre)} ${escapeHtml(r.apellidos)}<br><small>${escapeHtml(r.email)}</small></td>
                                <td>${formatearFecha(r.fecha)}</td>
                                <td>${escapeHtml(r.hora)}</td>
                                <td>${escapeHtml(r.personas)}</td>
                                <td><span class="status-badge status-${escapeHtml(r.estado)}">${escapeHtml(r.estado)}</span></td>
                                <td>
                                    <div class="action-buttons">
                                        <button class="btn-view" onclick='verDetalles(${JSON.stringify(r).replace(/'/g, "&#39;")})' title="Ver"><i class="fas fa-eye"></i></button>
                                        <button class="btn-edit" onclick='abrirEdicion(${JSON.stringify(r).replace(/'/g, "&#39;")})' title="Editar"><i class="fas fa-edit"></i></button>
                                        ${r.estado === 'confirmada' ? `<button class="btn-cancel" onclick="cancelarReserva('${escapeHtml(r.codigo)}')" title="Cancelar"><i class="fas fa-times"></i></button>` : ''}
                                    </div>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;

            container.innerHTML = html;
        }

        function verDetalles(r) {
            const content = document.getElementById('detailsContent');
            content.innerHTML = `
                <div style="display: grid; gap: 10px;">
                    <p><strong>Código:</strong> ${escapeHtml(r.codigo)}</p>
                    <p><strong>Estado:</strong> <span class="status-badge status-${escapeHtml(r.estado)}">${escapeHtml(r.estado)}</span></p>
                    <hr>
                    <p><strong>Cliente:</strong> ${escapeHtml(r.nombre)} ${escapeHtml(r.apellidos)}</p>
                    <p><strong>Email:</strong> ${escapeHtml(r.email)}</p>
                    <p><strong>Teléfono:</strong> ${escapeHtml(r.telefono || '-')}</p>
                    <hr>
                    <p><strong>Fecha:</strong> ${formatearFecha(r.fecha)}</p>
                    <p><strong>Hora:</strong> ${escapeHtml(r.hora)}</p>
                    <p><strong>Personas:</strong> ${escapeHtml(r.personas)}</p>
                    <p><strong>Ubicación:</strong> ${escapeHtml(r.ubicacion || 'General')}</p>
                    <hr>
                    <p><strong>Comentarios:</strong><br>${escapeHtml(r.comentarios || 'Sin comentarios')}</p>
                    <p><strong>Fecha Creación:</strong> ${r.created_at ? new Date(r.created_at).toLocaleString() : '-'}</p>
                </div>
            `;
            document.getElementById('detailsModal').style.display = 'flex';
        }

        async function cancelarReserva(codigo) {
            if (!confirm('¿Estás seguro de que quieres cancelar esta reserva? Esta acción no se puede deshacer.')) {
                return;
            }

            try {
                const response = await fetch(`${API_URL}/reservas/${codigo}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': authHeader,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ motivo: 'Cancelado por administrador' })
                });

                const result = await response.json();

                if (result.success) {
                    alert('Reserva cancelada correctamente');
                    cargarReservas(currentPage);
                } else {
                    alert('Error: ' + result.message);
                }
            } catch (error) {
                console.error(error);
                alert('Error de conexión al cancelar');
            }
        }

        function actualizarEstadisticas(reservas) {
            const total = reservas.length;
            const personas = reservas.reduce((acc, r) => acc + r.personas, 0);
            
            // Si estamos filtrando por hoy (comportamiento por defecto)
            const filtroFecha = document.getElementById('filtroFecha').value;
            const hoy = new Date().toISOString().split('T')[0];
            const esHoy = filtroFecha === hoy;
            
            if (esHoy) {
                document.getElementById('totalReservas').textContent = total;
                document.getElementById('totalPersonas').textContent = personas;
                document.getElementById('ocupacion').textContent = personas > 0 ? `${personas} p.` : '-';
                // Para reservasSemana dejamos el placeholder o lo ocultamos si no tenemos ese dato
                document.getElementById('reservasSemana').parentElement.style.opacity = '0.5';
            } else {
                // Si no es hoy, actualizamos con los datos visibles pero indicamos que es filtrado
                document.getElementById('totalReservas').textContent = total;
                document.getElementById('totalPersonas').textContent = personas;
                document.getElementById('ocupacion').textContent = '-';
            }
        }

        function abrirEdicion(r) {
            document.getElementById('editCodigo').value = r.codigo;
            document.getElementById('editNombre').value = r.nombre;
            document.getElementById('editApellidos').value = r.apellidos;
            document.getElementById('editEmail').value = r.email;
            document.getElementById('editFecha').value = r.fecha;
            document.getElementById('editHora').value = r.hora;
            document.getElementById('editPersonas').value = r.personas;
            document.getElementById('editModal').style.display = 'flex';
        }

        async function guardarEdicion(e) {
            e.preventDefault();
            const codigo = document.getElementById('editCodigo').value;
            const data = {
                nombre: document.getElementById('editNombre').value,
                apellidos: document.getElementById('editApellidos').value,
                email: document.getElementById('editEmail').value,
                fecha: document.getElementById('editFecha').value,
                hora: document.getElementById('editHora').value,
                personas: document.getElementById('editPersonas').value
            };

            try {
                const response = await fetch(`${API_URL}/reservas/${codigo}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': authHeader,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (result.success) {
                    alert('Reserva actualizada correctamente');
                    document.getElementById('editModal').style.display = 'none';
                    cargarReservas(currentPage);
                } else {
                    alert('Error: ' + result.message);
                }
            } catch (error) {
                console.error(error);
                alert('Error de conexión');
            }
        }

        function exportarCSV() {
            const fecha = document.getElementById('filtroFecha').value;
            const estado = document.getElementById('filtroEstado').value;
            const busqueda = document.getElementById('filtroBusqueda').value;

            let url = `${API_URL}/reservas/admin/lista?format=csv&`;
            if (fecha) url += `fecha=${fecha}&`;
            if (estado) url += `estado=${estado}&`;
            if (busqueda) url += `busqueda=${encodeURIComponent(busqueda)}&`;

            // Añadir auth token a la URL (no es lo más seguro pero para descarga directa es necesario
            // ya que no podemos enviar headers en window.location).
            // ALTERNATIVA MEJOR: Hacer fetch blob y descargar.
            
            descargarCSV(url);
        }

        async function descargarCSV(url) {
            try {
                const response = await fetch(url, {
                    headers: { 'Authorization': authHeader }
                });
                
                if (response.status === 401) {
                    alert('Sesión expirada');
                    logout();
                    return;
                }

                const blob = await response.blob();
                const downloadUrl = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = downloadUrl;
                a.download = `reservas-${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(a);
                a.click();
                a.remove();
            } catch (error) {
                console.error(error);
                alert('Error al descargar CSV');
            }
        }
    </script>
</body>
</html>
